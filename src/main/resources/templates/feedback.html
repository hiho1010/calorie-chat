<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>GPT 식단 피드백</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="text-center mb-4">
        <h1 class="text-success fw-bold">🥗 GPT 식단 피드백</h1>
        <p class="text-muted">오늘의 식단 정보와 피드백을 확인해보세요.</p>
    </div>

    <div id="__meta" th:data-userid="${userId}" class="d-none"></div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h4 class="card-title">🍽️ 오늘의 식단 정보</h4>
            <div id="meal-info" class="mt-3 text-body"></div>
        </div>
    </div>

    <div class="card shadow-sm mb-4" id="today-feedback-card" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">🧠 오늘의 GPT 피드백</h5>
            <div id="today-feedback" class="text-body"></div>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-success px-4" id="generate-feedback">🧠 GPT 피드백 생성</button>
    </div>

    <div id="loading" class="text-center text-primary fw-semibold" style="display: none;">GPT가 피드백을 분석 중입니다...</div>
    <div id="feedback-box" class="alert alert-info mt-4" style="display: none;"></div>

    <div class="my-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button id="prevMonth" class="btn btn-outline-primary btn-sm">◀ 이전 달</button>
            <h5 class="text-primary mb-0" id="calendar-title">2025년 6월</h5>
            <button id="nextMonth" class="btn btn-outline-primary btn-sm">다음 달 ▶</button>
        </div>
        <div id="feedback-calendar"></div>
    </div>

</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">📋 GPT 피드백 전체 보기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body" id="feedbackModalContent"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const userId = document.getElementById("__meta").dataset.userid;
    let mealId = null;
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    fetch(`/api/users/${userId}/meals/today/all`)
        .then(res => res.ok ? res.json() : Promise.reject("no meal"))
        .then(meals => {
            const mealInfoBox = document.getElementById("meal-info");
            mealInfoBox.innerHTML = ""; // 기존 내용 초기화

            meals.forEach(data => {
                const mealHtml = `
                <div class="mb-4">
                    <p><strong>식사 시간:</strong> ${data.mealTime}</p>
                    <p><strong>총 칼로리:</strong> ${data.totalCalories} kcal</p>
                    <ul class="list-group mt-3">
                        ${data.foodItems.map(item =>
                    `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${item.name}
                                <span>${item.calories} kcal × ${item.quantity}</span>
                            </li>`).join('')}
                    </ul>
                </div>
            `;
                mealInfoBox.innerHTML += mealHtml;
            });

            fetchTodayFeedback(); // 🍽 식단 정상 로딩 후 피드백도 호출
        })
        .catch(() => {
            document.getElementById("meal-info").innerHTML = `<div class="alert alert-warning">오늘 등록된 식단이 없습니다.</div>`;
            document.getElementById("generate-feedback").disabled = true;
        });


    function fetchTodayFeedback() {
        fetch(`/api/feedback/${userId}/today`)
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(data => {
                document.getElementById("today-feedback").innerText = data.feedback;
                document.getElementById("today-feedback-card").style.display = "block";
            })
            .catch(() => {
                document.getElementById("today-feedback-card").style.display = "none";
            });
    }

    document.getElementById("generate-feedback").addEventListener("click", () => {
        if (!userId) return;
        document.getElementById("loading").style.display = "block";
        document.getElementById("feedback-box").style.display = "none";

        fetch(`/api/feedback/generate/from-today?userId=${userId}`, {
            method: "POST"
        })
            .then(res => {
                if (!res.ok) throw new Error("GPT 피드백 생성 실패");
                return res.text();
            })
            .then(text => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("feedback-box").style.display = "block";
                document.getElementById("feedback-box").innerText = text;
                fetchTodayFeedback();
                loadFeedbackCalendar();
            })
            .catch(() => {
                document.getElementById("loading").style.display = "none";
                alert("GPT 피드백 요청 중 오류 발생!");
            });
    });

    document.getElementById("prevMonth").addEventListener("click", () => {
        if (--currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        loadFeedbackCalendar();
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
        if (++currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        loadFeedbackCalendar();
    });

    function loadFeedbackCalendar() {
        fetch(`/api/feedback/${userId}`)
            .then(res => res.json())
            .then(renderFeedbackCalendar);
    }

    function renderFeedbackCalendar(feedbackList) {
        const grouped = {};
        feedbackList.forEach(fb => {
            const date = new Date(fb.createdAt);
            const key = date.toISOString().split("T")[0];
            grouped[key] = grouped[key] || [];
            grouped[key].push(fb.feedback);
        });

        document.getElementById("calendar-title").innerText = `${currentYear}년 ${currentMonth + 1}월`;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

        // 42칸(6주 × 7일) 고정 배열
        const cells = Array.from({ length: 42 }, (_, i) => {
            const day = i - firstDay + 1;
            return day > 0 && day <= lastDate ? day : null;
        });

        let html = `
        <div class="row text-center fw-bold border-bottom pb-2">
            <div class="col">일</div><div class="col">월</div><div class="col">화</div>
            <div class="col">수</div><div class="col">목</div><div class="col">금</div><div class="col">토</div>
        </div>
    `;

        // 주 단위로만 row 생성 (실제 날짜가 하나라도 포함된 주만)
        for (let i = 0; i < 42; i += 7) {
            const week = cells.slice(i, i + 7);
            const hasAnyDay = week.some(day => day !== null);
            if (!hasAnyDay) continue; // 빈 주(예: 7칸 전부 null)는 렌더링 안함

            html += `<div class="row text-center">`;
            week.forEach(day => {
                if (day === null) {
                    html += `<div class="col border bg-light py-3"></div>`;
                } else {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const feedbacks = grouped[dateStr];
                    html += `<div class="col border p-2 calendar-day" style="height: 150px; overflow-y:auto; white-space: pre-wrap; font-size: 14px;">
                    <div><strong>${day}</strong></div>`;
                    if (feedbacks) {
                        feedbacks.forEach(f => {
                            const short = f.length > 20 ? f.slice(0, 20) + "..." : f;
                            html += `<div class="text-success small mt-1" style="cursor:pointer;" onclick="showModal(\`${f.replace(/`/g, '\\`')}\`)">${short}</div>`;
                        });
                    } else {
                        html += `<div class="text-muted small">-</div>`;
                    }
                    html += `</div>`;
                }
            });
            html += `</div>`;
        }

        document.getElementById("feedback-calendar").innerHTML = html;
    }




    function showModal(feedbackText) {
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        document.getElementById('feedbackModalContent').innerText = feedbackText;
        modal.show();
    }

    loadFeedbackCalendar();
</script>
</body>
</html>
