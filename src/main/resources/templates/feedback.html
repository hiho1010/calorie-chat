<!--
&lt;!&ndash; templates/feedback.html &ndash;&gt;
<section th:fragment="content" class="row justify-content-center mt-5">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h2 class="mb-4 text-center text-primary-green">GPT í”¼ë“œë°±</h2>

                &lt;!&ndash; ë²„íŠ¼ &ndash;&gt;
                <div class="d-flex justify-content-between mb-4">
                    <button class="btn btn-primary-green" id="generateBtn">GPT í”¼ë“œë°± ìƒì„±</button>
                </div>

                &lt;!&ndash; ì˜¤ëŠ˜ì GPT í”¼ë“œë°± &ndash;&gt;
                <div id="feedbackContent" class="mb-4">
                    <p class="text-muted">GPTì˜ ë¶„ì„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”...</p>
                </div>

                &lt;!&ndash; ìº˜ë¦°ë” ì´ë™ ë²„íŠ¼ &ndash;&gt;
                <div class="text-center my-3">
                    <button class="btn btn-sm btn-outline-primary me-2" id="prevMonthBtn">â—€ ì´ì „ ë‹¬</button>
                    <button class="btn btn-sm btn-outline-primary" id="nextMonthBtn">ë‹¤ìŒ ë‹¬ â–¶</button>
                </div>
                <div id="calendarFeedback"></div>

                &lt;!&ndash; ë‹¤ì‹œ ë³´ê¸° &ndash;&gt;
                <div class="text-center mt-3">
                    <button class="btn btn-primary-green" id="refreshBtn">ë‹¤ì‹œ ë³´ê¸°</button>
                </div>

                &lt;!&ndash; í™ˆ ë§í¬ &ndash;&gt;
                <div class="text-center mt-3">
                    <a th:href="@{/}" class="text-decoration-none">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                </div>

                &lt;!&ndash; userId ì €ì¥ &ndash;&gt;
                <div id="__meta" th:data-userid="${userId}" class="d-none"></div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const userId = document.getElementById("__meta").dataset.userid;
        const feedbackContainer = document.getElementById("feedbackContent");
        const calendarDiv = document.getElementById("calendarFeedback");
        const refreshBtn = document.getElementById("refreshBtn");
        const generateBtn = document.getElementById("generateBtn");
        let calendarYear = new Date().getFullYear();
        let calendarMonth = new Date().getMonth();

        async function loadTodayFeedback() {
            try {
                const res = await fetch(`/api/feedback/${userId}/today`);
                if (res.status === 404) {
                    const data = await res.json();
                    feedbackContainer.innerHTML = `
            <div class="alert alert-warning">
              ${data.message}<br>
              GPT í”¼ë“œë°±ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.
            </div>`;
                    return;
                }
                if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");

                const data = await res.json();
                feedbackContainer.innerHTML = `
          <h5 class="text-success">ê°€ì¥ ìµœê·¼ì— ë°›ì€ í”¼ë“œë°±</h5>
          <p class="mt-3">${data.feedback}</p>
          <p class="text-end text-muted small">${new Date(data.createdAt).toLocaleString()}</p>`;
            } catch (err) {
                feedbackContainer.innerHTML = `
          <div class="alert alert-danger">
            í”¼ë“œë°±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          </div>`;
                console.error(err);
            }
        }

        async function generateFeedback() {
            try {
                const res = await fetch(`/api/feedback/generate/from-today?userId=${userId}`, {
                    method: 'POST'
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || "ì„œë²„ ì˜¤ë¥˜");
                }

                const text = await res.text();
                feedbackContainer.innerHTML = `
            <h5 class="text-success">GPT í”¼ë“œë°±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</h5>
            <p class="mt-3">${text}</p>
            <p class="text-muted small">â€» ì˜¤ëŠ˜ ë“±ë¡ëœ ì‹ë‹¨ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        `;

                await loadCalendarFeedback(); // ìƒˆ í”¼ë“œë°± ìƒê²¼ìœ¼ë‹ˆ ë‹¬ë ¥ ê°±ì‹ ë„ ì¶”ê°€
            } catch (err) {
                feedbackContainer.innerHTML = `
            <div class="alert alert-danger">
                í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨: ${err.message}
            </div>`;
                console.error(err);
            }
        }

        async function loadCalendarFeedback() {
            try {
                const res = await fetch(`/api/feedback/${userId}`);
                if (!res.ok) throw new Error("ì¡°íšŒ ì‹¤íŒ¨");
                const data = await res.json();
                renderFeedbackCalendar(calendarYear, calendarMonth, data);
                calendarDiv.classList.remove("d-none");
            } catch (err) {
                calendarDiv.innerHTML = `<div class="alert alert-danger">ë‹¬ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
                console.error(err);
            }
        }

        function renderFeedbackCalendar(year, month, data) {
            const grouped = {};
            data.forEach(fb => {
                const date = new Date(fb.createdAt);
                const key = date.toISOString().split("T")[0];
                grouped[key] = grouped[key] || [];
                grouped[key].push(fb.feedback);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            let html = `<h5 class="text-primary mb-3">${year}ë…„ ${month + 1}ì›” GPT í”¼ë“œë°±</h5>`;
            html += `<div class="row text-center fw-bold border-bottom pb-2">
        <div class="col">ì¼</div><div class="col">ì›”</div><div class="col">í™”</div>
        <div class="col">ìˆ˜</div><div class="col">ëª©</div><div class="col">ê¸ˆ</div><div class="col">í† </div>
      </div><div class="row text-center">`;

            for (let i = 0; i < firstDay; i++) html += `<div class="col border py-3 bg-light"></div>`;

            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const feedbacks = grouped[dateStr];
                html += `<div class="col border py-2" style="height:100px; overflow:auto;">
          <div><strong>${d}</strong></div>`;
                if (feedbacks) {
                    html += `<div class="text-success small mt-1">${feedbacks.join("<br>")}</div>`;
                } else {
                    html += `<div class="text-muted small mt-1">-</div>`;
                }
                html += `</div>`;
                if ((firstDay + d) % 7 === 0) html += `</div><div class="row text-center">`;
            }
            html += `</div>`;
            calendarDiv.innerHTML = html;
        }

        document.getElementById("prevMonthBtn").addEventListener("click", () => {
            if (&#45;&#45;calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear&#45;&#45;;
            }
            loadCalendarFeedback();
        });

        document.getElementById("nextMonthBtn").addEventListener("click", () => {
            if (++calendarMonth > 11) {
                calendarMonth = 0;
                calendarYear++;
            }
            loadCalendarFeedback();
        });

        refreshBtn.addEventListener("click", loadTodayFeedback);
        generateBtn.addEventListener("click", generateFeedback);

        loadTodayFeedback();
        loadCalendarFeedback();
        loadCalendarFeedback(); // âœ… ë°”ë¡œ ë¡œë”©ë˜ë„ë¡ ë³€ê²½
    });
</script>
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>GPT ì‹ë‹¨ í”¼ë“œë°±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="text-center mb-4">
        <h1 class="text-success fw-bold">ğŸ¥— GPT ì‹ë‹¨ í”¼ë“œë°±</h1>
        <p class="text-muted">ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ì •ë³´ì™€ í”¼ë“œë°±ì„ í™•ì¸í•´ë³´ì„¸ìš”.</p>
    </div>

    <div id="__meta" th:data-userid="${userId}" class="d-none"></div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h4 class="card-title">ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ì •ë³´</h4>
            <div id="meal-info" class="mt-3 text-body"></div>
        </div>
    </div>

    <div class="card shadow-sm mb-4" id="today-feedback-card" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">ğŸ§  ì˜¤ëŠ˜ì˜ GPT í”¼ë“œë°±</h5>
            <div id="today-feedback" class="text-body"></div>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-success px-4" id="generate-feedback">ğŸ§  GPT í”¼ë“œë°± ìƒì„±</button>
    </div>

    <div id="loading" class="text-center text-primary fw-semibold" style="display: none;">GPTê°€ í”¼ë“œë°±ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
    <div id="feedback-box" class="alert alert-info mt-4" style="display: none;"></div>

    <div class="my-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button id="prevMonth" class="btn btn-outline-primary btn-sm">â—€ ì´ì „ ë‹¬</button>
            <h5 class="text-primary mb-0" id="calendar-title">2025ë…„ 6ì›”</h5>
            <button id="nextMonth" class="btn btn-outline-primary btn-sm">ë‹¤ìŒ ë‹¬ â–¶</button>
        </div>
        <div id="feedback-calendar"></div>
    </div>

    <footer class="text-center mt-5 text-muted small">
        Â© 2025 CalorieChat â€” ê±´ê°•í•œ ì‚¶ì„ ì‘ì›í•©ë‹ˆë‹¤!
    </footer>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">ğŸ“‹ GPT í”¼ë“œë°± ì „ì²´ ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body" id="feedbackModalContent"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const userId = document.getElementById("__meta").dataset.userid;
    let mealId = null;
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    fetch(`/api/users/${userId}/meals/today/detail`)
        .then(res => res.ok ? res.json() : Promise.reject("no meal"))
        .then(data => {
            mealId = data.mealId;
            document.getElementById("meal-info").innerHTML = `
                <p><strong>ì‹ì‚¬ ì‹œê°„:</strong> ${data.mealTime}</p>
                <p><strong>ì´ ì¹¼ë¡œë¦¬:</strong> ${data.totalCalories} kcal</p>
                <ul class="list-group mt-3">
                    ${data.foodItems.map(item =>
                `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${item.name}
                        <span>${item.calories} kcal Ã— ${item.quantity}</span>
                    </li>`).join('')}
                </ul>`;
            fetchTodayFeedback();
        })
        .catch(() => {
            document.getElementById("meal-info").innerHTML = `<div class="alert alert-warning">ì˜¤ëŠ˜ ë“±ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            document.getElementById("generate-feedback").disabled = true;
        });

    function fetchTodayFeedback() {
        fetch(`/api/feedback/${userId}/today`)
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(data => {
                document.getElementById("today-feedback").innerText = data.feedback;
                document.getElementById("today-feedback-card").style.display = "block";
            })
            .catch(() => {
                document.getElementById("today-feedback-card").style.display = "none";
            });
    }

    document.getElementById("generate-feedback").addEventListener("click", () => {
        if (!userId) return;
        document.getElementById("loading").style.display = "block";
        document.getElementById("feedback-box").style.display = "none";

        fetch(`/api/feedback/generate/from-today?userId=${userId}`, {
            method: "POST"
        })
            .then(res => {
                if (!res.ok) throw new Error("GPT í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨");
                return res.text();
            })
            .then(text => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("feedback-box").style.display = "block";
                document.getElementById("feedback-box").innerText = text;
                fetchTodayFeedback();
                loadFeedbackCalendar();
            })
            .catch(() => {
                document.getElementById("loading").style.display = "none";
                alert("GPT í”¼ë“œë°± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
            });
    });

    document.getElementById("prevMonth").addEventListener("click", () => {
        if (--currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        loadFeedbackCalendar();
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
        if (++currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        loadFeedbackCalendar();
    });

    function loadFeedbackCalendar() {
        fetch(`/api/feedback/${userId}`)
            .then(res => res.json())
            .then(renderFeedbackCalendar);
    }

    function renderFeedbackCalendar(feedbackList) {
        const grouped = {};
        feedbackList.forEach(fb => {
            const date = new Date(fb.createdAt);
            const key = date.toISOString().split("T")[0];
            grouped[key] = grouped[key] || [];
            grouped[key].push(fb.feedback);
        });

        document.getElementById("calendar-title").innerText = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

        let html = `<div class="row text-center fw-bold border-bottom pb-2">
            <div class="col">ì¼</div><div class="col">ì›”</div><div class="col">í™”</div>
            <div class="col">ìˆ˜</div><div class="col">ëª©</div><div class="col">ê¸ˆ</div><div class="col">í† </div>
          </div><div class="row text-center">`;

        for (let i = 0; i < firstDay; i++) html += `<div class="col border py-3 bg-light"></div>`;

        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const feedbacks = grouped[dateStr];
            html += `<div class="col border p-2" style="height:120px; font-size: 12px; overflow: hidden;">
              <div><strong>${d}</strong></div>`;
            if (feedbacks) {
                feedbacks.forEach(f => {
                    const short = f.length > 20 ? f.slice(0, 20) + "..." : f;
                    html += `<div class="text-success small mt-1" style="cursor:pointer;" onclick="showModal('${f.replace(/'/g, "\\'")}')">${short}</div>`;
                });
            } else {
                html += `<div class="text-muted small">-</div>`;
            }
            html += `</div>`;
            if ((firstDay + d) % 7 === 0) html += `</div><div class="row text-center">`;
        }
        html += `</div>`;
        document.getElementById("feedback-calendar").innerHTML = html;
    }

    function showModal(feedbackText) {
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        document.getElementById('feedbackModalContent').innerText = feedbackText;
        modal.show();
    }

    loadFeedbackCalendar();
</script>
</body>
</html>
