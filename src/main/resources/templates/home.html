<!-- templates/home.html -->
<section th:fragment="content"
         xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

  <!-- 사용자 정보 메타 -->
  <div id="__meta"
       th:data-userid="${session.LOGIN_USER_ID}"
       th:data-username="${session.LOGIN_USER_NAME}"
       th:data-goal-weight="${session.LOGIN_USER_GOAL_WEIGHT}"></div>

  <!-- 인사말 & 식단 등록 버튼 -->
  <div sec:authorize="isAuthenticated()" class="mt-4">
    <h2 th:text="'안녕하세요, ' + (${session.LOGIN_USER_NAME} ?: '회원') + ' 님!'"></h2>

  </div>

  <!-- 새 몸무게 기록 / GPT 피드백 -->
  <div class="mt-4 d-flex justify-content-between">
    <a class="btn btn-primary-green"
       href="#"
       data-bs-toggle="modal"
       data-bs-target="#weightModal">
      새 몸무게 기록
    </a>
    <a class="btn btn-primary-green" href="#" data-bs-toggle="modal" data-bs-target="#mealModal">
      식단 등록하기
    </a>
  </div>

  <!-- 권장 칼로리 -->
  <!-- ↓ 권장 칼로리: 버튼 대신 텍스트로 노출 -->
  <div class="mt-4">
    <p class="fs-5">
      🎯 목표 몸무게:
      <span th:text="${session.LOGIN_USER_GOAL_WEIGHT} ?: '–'"></span> kg
    </p>
    <p class="fs-5">
      🔥 하루 권장 칼로리:
      <span id="targetCalText" class="fw-bold">로딩 중…</span> kcal
    </p>
  </div>

  <!-- 몸무게 추이 차트 -->
  <h2 class="mt-5 mb-3">📈 나의 체중 추이</h2>
  <canvas id="weightChart" height="120"></canvas>

  <div class="mt-4">
    <a class="btn btn-outline-secondary" th:href="@{/feedback}">GPT 피드백 받기</a>
  </div>

  <!-- ===== 식단 입력 모달 ===== -->
  <div class="modal fade" id="mealModal" tabindex="-1" aria-labelledby="mealModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <h5 class="modal-title mb-3">식단 등록</h5>

        <form id="mealForm">
          <div class="mb-2">
            <label for="mealTime" class="form-label">식사 종류</label>
            <select class="form-select" id="mealTime" required>
              <option value="BREAKFAST">아침</option>
              <option value="LUNCH">점심</option>
              <option value="DINNER">저녁</option>
              <option value="SNACK">간식</option>
            </select>
          </div>

          <div class="mb-2">
            <label for="eatenAt" class="form-label">섭취 시간</label>
            <input type="datetime-local" class="form-control" id="eatenAt" required />
          </div>

          <div id="foodItemsContainer"></div>

          <button type="button" class="btn btn-sm btn-outline-secondary mb-2" id="addFoodItemBtn">+ 음식 추가</button>

          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="submit" class="btn btn-primary">등록</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== 몸무게 입력 모달 ===== -->
  <div class="modal fade" id="weightModal" tabindex="-1"
       aria-labelledby="weightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <h5 class="modal-title mb-3" id="weightModalLabel">몸무게 기록</h5>

        <form id="weightForm">
          <div class="mb-2">
            <label for="weightDate" class="form-label">측정 날짜</label>
            <!-- 수정: value 대신 th:value 로 오늘 날짜 세팅 -->
            <input
                type="date"
                class="form-control"
                id="weightDate"
                th:value="${T(java.time.LocalDate).now()}"
                required
            />
          </div>

          <div class="mb-2">
            <label for="weightValue" class="form-label">몸무게 (kg)</label>
            <input
                type="number"
                class="form-control"
                id="weightValue"
                step="0.1"
                min="0"
                required
            />
          </div>

          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="submit" class="btn btn-primary">저장</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== 스크립트 ===== -->
  <script src="/js/weight-chart.js"></script>
  <script src="/js/meal-register.js"></script>
  <script th:src="@{/webjars/chart.js/dist/chart.umd.js}"></script>
  <script src="/js/profile-calorie.js"></script>
  <script src="/js/weight-register.js"></script>
</section>